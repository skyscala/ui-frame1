aW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnOwoKQEluamVjdGFibGUoewogIHByb3ZpZGVkSW46ICdyb290Jwp9KQpleHBvcnQgY2xhc3MgUXVlcnlIZWxwZXJTZXJ2aWNlIHsKCiAgY29uc3RydWN0b3IoKSB7IH0KCgogIGRlZmluZUJpelN0cmluZ1R5cGVGaWx0ZXJQYXJhbShrOiBzdHJpbmcsIGFycjogYW55KTogYW55IHsKICAgIGlmIChhcnIpIHsKICAgICAgaWYoQXJyYXkuaXNBcnJheShhcnIpKXsKICAgICAgICByZXR1cm4gYXJyLm1hcChlID0-CiAgICAgICAgICB0aGlzLmRlZmluZVN0cmluZ0ZpbHRlclBhcmFtKGssIGUudmFsdWUsIHRoaXMubWFwU3RyaW5nRmlsdGVyRXhwcmVzc2lvbihlLm1hdGNoTW9kZSkpCiAgICAgICAgKTsKICAgICAgfWVsc2V7CiAgICAgICAgcmV0dXJuIFt0aGlzLmRlZmluZVN0cmluZ0ZpbHRlclBhcmFtKGssIGFyci52YWx1ZSwgdGhpcy5tYXBTdHJpbmdGaWx0ZXJFeHByZXNzaW9uKGFyci5tYXRjaE1vZGUpKV07ICAgIAogICAgICB9ICAgICAgCiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIGRlZmluZUJpelN0cmluZ0FycmF5VHlwZUZpbHRlclBhcmFtKGs6IHN0cmluZywgaW5uZXJLZXk6c3RyaW5nLCBhcnI6IGFueSk6IGFueSB7CiAgICBjb25zb2xlLmxvZyhhcnIpOwogICAgaWYgKGFycikgewogICAgICBpZihBcnJheS5pc0FycmF5KGFycikpewogICAgICAgIGNvbnNvbGUubG9nKCJpcyBhcnJheS4uIik7CiAgICAgICAgcmV0dXJuIGFyci5tYXAoZSA9PgogICAgICAgICAgdGhpcy5kZWZpbmVTdHJpbmdBcnJheUZpbHRlclBhcmFtKGssIGlubmVyS2V5LCBlLnZhbHVlLCB0aGlzLm1hcFN0cmluZ0FycmF5RmlsdGVyRXhwcmVzc2lvbihlLm1hdGNoTW9kZSkpCiAgICAgICAgKTsKICAgICAgfSAgIAogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBkZWZpbmVCaXpEYXRlVHlwZUZpbHRlclBhcmFtKGs6IHN0cmluZywgYXJyOiBhbnkpOiBhbnkgewogICAgaWYgKGFycikgewogICAgICBpZihBcnJheS5pc0FycmF5KGFycikpewogICAgICAgIHJldHVybiBhcnIubWFwKGUgPT4KICAgICAgICAgIHRoaXMuZGVmaW5lRGF0ZUZpbHRlclBhcmFtKGssIGUudmFsdWUsIHRoaXMubWFwRGF0ZUZpbHRlckV4cHJlc3Npb24oZS5tYXRjaE1vZGUpKQogICAgICAgICk7CiAgICAgIH0gICAgCiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCgogIG1hcFN0cmluZ0ZpbHRlckV4cHJlc3Npb24oZTogc3RyaW5nKTogc3RyaW5nIHsKICAgIGlmIChlKSB7CiAgICAgIGlmIChlID09PSAibm90RXF1YWxzIikgewogICAgICAgIHJldHVybiAibmUiOwogICAgICB9IGVsc2UgaWYgKGUgPT09ICJzdGFydHNXaXRoIikgewogICAgICAgIHJldHVybiAic3RhcnRzV2l0aElnbm9yZUNhc2UiOwogICAgICB9IGVsc2UgaWYgKGUgPT09ICJlbmRzV2l0aCIpIHsKICAgICAgICByZXR1cm4gImVuZHNXaXRoSWdub3JlQ2FzZSI7CiAgICAgIH0gZWxzZSBpZiAoZSA9PT0gImNvbnRhaW5zIikgewogICAgICAgIHJldHVybiAiY29udGFpbnNJZ25vcmVDYXNlIjsKICAgICAgfQogICAgICByZXR1cm4gZTsKICAgIH0KICAgIHJldHVybiAiZXF1YWxzIjsKICB9CgogIG1hcFN0cmluZ0FycmF5RmlsdGVyRXhwcmVzc2lvbihlOiBzdHJpbmcpOiBzdHJpbmcgeyAgICAKICAgIHJldHVybiAiaW4iOwogIH0KCiAgbWFwRGF0ZUZpbHRlckV4cHJlc3Npb24oZTogc3RyaW5nKTogc3RyaW5nIHsKICAgIGlmIChlKSB7CiAgICAgIGlmIChlID09PSAiZGF0ZUJlZm9yZSIpIHsKICAgICAgICByZXR1cm4gImJlZm9yZSI7CiAgICAgIH0gZWxzZSBpZiAoZSA9PT0gImRhdGVBZnRlciIpIHsKICAgICAgICByZXR1cm4gImFmdGVyIjsKICAgICAgfQogICAgICByZXR1cm4gZTsKICAgIH0KICAgIHJldHVybiAiZXF1YWxzIjsKICB9CiAgCgogIGRlZmluZVN0cmluZ0ZpbHRlclBhcmFtKGs6IHN0cmluZywgdjogQXJyYXk8c3RyaW5nPiwgZTogc3RyaW5nKTogYW55IHsKICAgIGNvbnNvbGUubG9nKHYpOwogICAgaWYgKGsgJiYgdiAmJiBlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZmlsdGVyVHlwZTogInRleHQiLAogICAgICAgIGZpbHRlckV4cHJlc3Npb246IGUsCiAgICAgICAga2V5OiBrLAogICAgICAgIHRleHRWYWx1ZTogewogICAgICAgICAgdmFsdWU6IHYKICAgICAgICB9LAogICAgICAgIG9yZGVyOiAwCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIGRlZmluZVN0cmluZ0FycmF5RmlsdGVyUGFyYW0oazogc3RyaW5nLCBpbm5lcktleTphbnksIHY6IEFycmF5PHN0cmluZz4sIGU6IHN0cmluZyk6IGFueSB7CiAgICBjb25zb2xlLmxvZyh2KTsKICAgIGlmIChrICYmIEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGg-MCAmJiBlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZmlsdGVyVHlwZTogInRleHRBcnJheSIsCiAgICAgICAgZmlsdGVyRXhwcmVzc2lvbjogZSwKICAgICAgICBrZXk6IGssCiAgICAgICAgdGV4dEFycmF5VmFsdWU6IHsKICAgICAgICAgIGxpc3Q6IHYubWFwKGUgPT4gZVtpbm5lcktleV0pCiAgICAgICAgfSwKICAgICAgICBvcmRlcjogMAogICAgICB9OwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBkZWZpbmVEYXRlRmlsdGVyUGFyYW0oazogc3RyaW5nLCB2OiBEYXRlLCBlOiBzdHJpbmcpOiBhbnkgewoKCiAgICBpZiAoayAmJiB2ICYmIGUpIHsKCiAgICAgIGNvbnN0IHl5eXk6bnVtYmVyPXYuZ2V0RnVsbFllYXIoKTsKICAgICAgY29uc3QgdGVtcE1NOm51bWJlcj12LmdldE1vbnRoKCkrMTsKICAgICAgY29uc3QgbW09dGVtcE1NPDEwPyIwIit0ZW1wTU06dGVtcE1NOwogICAgICBjb25zdCB0ZW1wREQ9di5nZXREYXRlKCk7CiAgICAgIGNvbnN0IGRkPXRlbXBERDwxMD8iMCIrdGVtcEREOnRlbXBERDsKCiAgICAgIHJldHVybiB7CiAgICAgICAgZmlsdGVyVHlwZTogImRhdGUiLAogICAgICAgIGZpbHRlckV4cHJlc3Npb246IGUsCiAgICAgICAga2V5OiBrLAogICAgICAgIGRhdGVWYWx1ZTogewogICAgICAgICAgZGF0ZTogKHl5eXkrIi0iK21tKyItIitkZCsiIDAwOjAwOjAwIikKICAgICAgICB9LAogICAgICAgIG9yZGVyOiAwCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIAoKICBkZWZpbmVTb3J0T3JkZXIob3JkOiBudW1iZXIpOiBzdHJpbmcgewogICAgaWYgKG9yZCAmJiBvcmQgPT0gMSkgewogICAgICByZXR1cm4gImFzYyI7CiAgICB9CiAgICByZXR1cm4gImRlc2MiOwogIH0KfQo