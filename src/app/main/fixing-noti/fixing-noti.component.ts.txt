import { Component, OnInit } from '@angular/core';
import { LazyLoadEvent, SelectItem, FilterMatchMode } from 'primeng/api';
import { FixingNotiService } from './fixing-noti.service';
@Component({
  selector: 'app-fixing-noti',
  templateUrl: './fixing-noti.component.html',
  styleUrls: ['./fixing-noti.component.scss']
})
export class FixingNotiComponent implements OnInit {

  fixingNotiSelectedFilters:any=null;
  fixNotiItems:Array<any>=[];
  fixNotiLoading:boolean=false;
  totalFixNotiRecordsCount:number=10;
  fixNotiFilters:Array<string>=new Array<string>();

  matchModeOptions: SelectItem[] = [
    { label: 'Equals', value: FilterMatchMode.EQUALS },
    { label: 'Starts With', value: FilterMatchMode.STARTS_WITH },
    { label: 'Ends With', value: FilterMatchMode.ENDS_WITH },
    { label: 'Contains', value: FilterMatchMode.CONTAINS }
  ];

  dateMatchModeOptions: SelectItem[] = [
    { label: 'Date is after', value: FilterMatchMode.DATE_AFTER },
    { label: 'Date is before', value: FilterMatchMode.DATE_BEFORE }
  ];

  counterparties:Array<any>=new Array<any>();

  constructor(private fixingNotifService:FixingNotiService){}

  ngOnInit(): void {
    
    this.fixNotiFilters.push(
      'ccy','counterparty','denom','family','fixingDate','group','interest','isin','market','mxInterestRef','n1','n2','nominal',
      'payInterestAmount','payRedemptionAmount','paymentDate','recordDate','region','settlementMode','startegy','type');
    
    this.counterparties.push({name:"counterparty1"},{name:"counterparty2"},{name:"counterparty3"});
    this.fixNotiItems=[];  
  }


  queryFixNotiItems($event:LazyLoadEvent){

    /*
      "ccy": this.fetchDisplayValue(itm, "refId"),
      "counterparty": this.fetchDisplayValue(itm, "code"),
      "denom": this.fetchDisplayValue(itm, "title"),
      "family": this.fetchDisplayValue(itm, "category"),
      "fixingDate": this.fetchDisplayValue(itm, "shortDescription"),
      "group": this.fetchDisplayValue(itm, "status"),
      "interest": this.fetchDisplayValue(itm, "unitPriceBase"),
      "isin": this.fetchDisplayValue(itm, "unitPricePromo"),
      "market": imagePathPrefix+this.fetchDisplayValue(itm,"imagePath"),
      "mxInterestRef": this.fetchDisplayValue(itm, "quantity"),
      "n1": this.fetchDisplayValue(itm, "createdDate"),
      "n2": this.fetchDisplayValue(itm, "updatedDate"),
      "n2": this.fetchDisplayValue(itm, "updatedDate")
    
    */

    //console.log($event);

    const fixingNotiQueryData = (this.fixingNotifService.defineQuery($event));

    const temp1=JSON.parse(fixingNotiQueryData);
    this.fixingNotiSelectedFilters=null;
    if(temp1&&temp1.filter&&temp1.filter.filterParams){
      this.fixingNotiSelectedFilters=(temp1.filter.filterParams.map( (e:any) => { 

        if(e.filterType==='text'&&e.textValue&&e.textValue.value){
          return (e.key +" "+e.filterExpression+" \""+e.textValue.value+"\"");
        }else if(e.filterType==='textArray'&&e.textArrayValue&&e.textArrayValue.list){
          return (e.key +" "+e.filterExpression+" "+JSON.stringify(e.textArrayValue.list)+"");
        }else if(e.filterType==='date'&&e.dateValue&&e.dateValue.date){
          return (e.key +" "+e.filterExpression+" \""+e.dateValue.date+"\"");
        }
      
        return "INVLD";
      }).filter((e:any) => e!=="INVLD").join(' & '));
    }
    //console.log(this.fixingNotiSelectedFilters);
  }


  fetchDisplayValue(itm:any, k:any) {
    if (itm.indexedData) {
      return itm.indexedData[k];
    } else {
      return itm[k];
    }
  }
}
