import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import { QueryHelperService } from '../utilities/query-helper.service';
import { ApiLookupsHelperService } from '../utilities/api-lookups-helper.service';
import { Observable } from 'rxjs';
@Injectable({
  providedIn: 'root'
})
export class FixingNotiService {

  constructor(private queryHelperSerivce:QueryHelperService,
    private apiLookupsHelperService:ApiLookupsHelperService,
    private httpClient:HttpClient) { }


  queryFixingNotiRecords(filterEvt:any):Observable<any>{
    const path="";
    const url = this.apiLookupsHelperService.apiRoot()+"/"+path;
    const body=this.defineQuery(filterEvt);
    return this.httpClient.post<any>(url,body).pipe(map(response => response));
    
  }  

  defineQuery(filterEvt: any): any {
    console.log("Looking for api..");
    this.apiLookupsHelperService.apiRoot();
    const pageNumber = filterEvt.first;
    const pageSize = filterEvt.rows;
    const sortParam = this.defineSortParam(filterEvt);
    const flt = this.defineFilters(filterEvt);

    const pgn = {
      pageNumber: parseInt((pageNumber / pageSize) + "") + 1,
      pageSize: pageSize
    };

    const srt = [
      {
        key: sortParam.key,
        order: 0,
        sortType: sortParam.sortType
      }
    ];

    return JSON.stringify(
      this.preparePayload(flt, pgn, srt)
    );
    
  }

  preparePayload(flt: any, pgn: any, srt: any): any {

    if (flt) {
      return {
        filter: flt,
        paginationParam: pgn,
        sortingParams: srt
      };
    }
    else {
      return {
        paginationParam: pgn,
        sortingParams: srt
      };
    }
  }

  defineFilters(filterEvt: any): any {

    const filters = filterEvt.filters;

    const arr:Array<any> = [];

   
    
    const filterParam1 = this.queryHelperSerivce.defineBizStringTypeFilterParam("isin", filters.isin);
    if (filterParam1) {
      this.copyElements(filterParam1, arr);
    }

    const filterParam2 = this.queryHelperSerivce.defineBizStringArrayTypeFilterParam("counterparty", "name", filters.counterparty);
    if (filterParam2) {
      this.copyElements(filterParam2, arr);
    }

    
    const filterParam3 = this.queryHelperSerivce.defineBizDateTypeFilterParam("fixingDate", filters.fixingDate);
    if (filterParam3) {
      this.copyElements(filterParam3, arr);
    }
    

    if (arr.length > 0) {
      return {
        filterParams: arr,
        logic: "and"
      };
    }

    return null;
  }

  copyElements(src: any, target: any) {
    for (const element of src) {
      if (element) {
        target.push(element);
      }
    }
  }

  defineSortParam(filterEvt: any): any {
    if (filterEvt.sortField) {

      const sortKey = filterEvt.sortField;
      const sortOrder = this.queryHelperSerivce.defineSortOrder(filterEvt.sortOrder);
      
      return { key: sortKey, order: 0, sortType: sortOrder };
    } else {
      return { key: "fixingDate", order: 0, sortType: "desc" };
    }
  }


  

}
